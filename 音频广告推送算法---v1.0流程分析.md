#音频广告推送算法---v1.0流程分析
## 写在前面
--------------------------------
这是对第一个版本v1.0流程的一些个人想法。也包括了一些技术点。
我认为先开发出一个简单可用的版本并在后续不断优化，要好于上来就设计一个大而复杂的模型，并且拥有更好的灵活性。

## 输入
--------------------------------
输入是由广告主决定的：  
    1 音频广告的标签，可能会有多个。
    2 每次推送的次数(我们也可以根据具体的标签给他一个次数的建议)<br>

## 我们需要做的事情：
--------------------------------
一、获取所有用户的行为。<br>
>   1 包括baiduID，userID(针对登陆用户)听歌时间，听歌时长，听歌内容(歌曲、歌手),设备型号，地理区域等。<br>
    2 最好有一个独立的ETL来获取这些数据。<br>
    3 Q:这个数据量会非常的大，怎样保存中间结果？<br>
    4 Q:怎样获取用户的行为？不是所有人，每天都使用产品的。若是以他最近一次的行为，那么获取全量用户时存在些麻烦。<br>

二、提取其中的登陆用户的属性。<br>
>   1 Q:这个数据量会非常的大，怎样保存中间结果？<br>

三、根据用户的行为和已有的登陆用户的属性，为非登录用户添加属性。<br>
>   1 Q:怎样才算是相似的？<br>
    2 Q:采用K-近邻算法将会极其耗费时间。因为每为一个非登录用户添加属性，都会遍历一遍所有登陆用户的属性。<br>
    3 Q:匹配时的行为维度不会是一样的权值。那么如何确定其权值？<br>
    4 这样的话，在匹配时，最好将用户的一些连续行为做离散化处理。<br>
    5 A:可以不使用KNN，而是设定一个阀值，这样在匹配非登录用户时，找到的第一个高于阀值的登陆用户，我们就认为他们有相同的属性。<br>
    6 Q:像上面所言，如何避免每次都从开头匹配，这样很容易和排在前面的登录用户匹配上的问题？<br>
         A:可以每次在登陆用户中，随机选择一个开始向下匹配。<br>
    7 Q:还是数据量大，保存的问题。<br>

四、筛选出符合条件的用户，为其推荐音频广告。<br>
>   1 根据广告主提出的标签来进行匹配，查找包含该标签的用户。<br>
    2 若是查找到的用户数量大于每次需要推送次数，则需要进行排序。越多标签符合的用户应该越靠前。<br>
    3 若是查找到的用户数量小于每次需要推送次数时：
      3.1 小于但是相差不大时：我们可以就推送这些用户，与广告主进行协商或是增加、多推荐的频度。<br>
      3.2 若是明显小于推送次数时：我们应该在登陆用户进行两两相似匹配，若是两个登陆的属性很相似，那么我们取他们属性的并集，将这个并集赋给这两个用户。<strong>(这个工作量会比较大)</strong><br>
    当然，希望推送的次数恰好等于我们筛选出来的用户数量，这样的概率是极小的。<br>
    4 Q:若A有100个属性，B有20个属性，那么进行标签匹配时，推送给A的概率就明显大于B了。这是不公平的。如何避免这种不公平(毕竟谁都不想被广告骚扰)？<br>
    5 Q:假定选出了10w待推送广告的用户，但是你不能保证这10w在短期内都会有使用，那么这样的话，就存在有些人的广告不能推送出去。此时该如何处理？<br>

## 后续可优化点：
-------------------------------
>   1 在用户收听的内容上深入做文章。毕竟喜欢同一个歌手的用户，他们的年龄兴趣相似可能性也大。<br>
    2 优化各个行为的权值。<br>
    3 对登陆用户的属性值加以利用。<br>  
    
<br>
######(以上问题写于2014-10-08，后续再更新)-----------
<br>
## 更新：
--------------------------------
1 上面设计的是基于用户上一次的行为设计的流程。但这样做会有一些麻烦：
>   1.1 新用户首次使用时是不会进行推送的。而新用户的比重很大。<br>
    1.2 事先选好的用户，不能保证短期内都会推送出去。<br>
    1.3 存储量非常的大，BaiduID在音乐端多达55亿+。（截止2014-10-08）<br>
我们要放弃这种策略，采用实时行为触发的模型。

2 目前要设计成实时投放的模型，即用户触发了某种行为就会推送一个广告。<br>
  但这样做对及时性的要求就有所提高，可以以降低准确性为代价。

3 后期需要根据经验估计广告容量。<br>
  例如：10w用户使用时，或许会投放15w广告。因为有的人收听时间可能会比较长，可能每听5首歌推荐一个音频。这样的话，这一个用户可能就是投放不只一个广告。

4 非登陆用户去和登陆用户匹配时，各种维度的权值根据不同的维度也应该是不同的。<br>
  即有可能母婴类的用户对内容维度相似度较大，而体育类的用户在时间上更加的相似。<br>
  因此，不同的标签要设计不同的权值list。

5 对于登陆用户，我们可以直接通过他的属性来进行推荐。这是最准确而且快捷的，也是我们期待的。<br>
  而对于非登陆的用户，我们就需要通过他的行为来预测他的属性值。<br>
  我们对非登陆用户的最终的目标是想找到`他的属性标签`，而不是`跟他最相似的K个登陆用户`。<br>
  所以，我们绕了一个圈子。<br>
  我们可以直接通过登陆用户的数据来训练一个模型，这个模型可以根据行为来直接为其预测标签。<br>
  这样就当模型训练完成后，再来对一个非登陆用户来预测就非常快了。不必再去一一比对登陆用户。

6 所以目前的主要难点和耗时点就是在于：
>   6.1 登陆用户数据的预处理。（格式，缺省值，连续值离散化等）<br>
    6.2 针对各个标签的权重计算。（还要考虑后续有新添加标签时的情况）<br>
    6.3 阈值、广告容量比值等参数值的经验估计。<br>
    6.4 满足要求用户数量低时的扩张处理。<br>

######(以上问题写于2014-10-09，后续再更新)-----------
<br>
和web-rd以及pm沟通后，流程有所更改：<br>
1 web端给我这边传递id。我们之间有共同的标签库。然后我针对这个id，给出他对每个标签的二分判断。<br>
2 id包括userid，baiduid，cuid。若是登陆用户，不论是哪个端的都以userid为准。否则，web端看baiduid，移动端看cuid。<br>
3 确定一级标签库后，返回一个bit串给web端同学。<br>
初稿如下：<br>
！[设计初稿](/images/design_ads.png)
######(以上问题写于2014-10-23，后续再更新)-----------

--------------------------------
######（转载本站文章请注明作者和出处 https://github.com/MangoLiu ，请勿用于任何商业用途）
